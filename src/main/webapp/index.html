<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title></title>

  <link rel="stylesheet" type="text/css" href="css/console.css"/>
  <link rel="stylesheet" href="css/codemirror.css">

  <!--
    <link rel="stylesheet/less" type="text/css" href="less/console.less"/>
    <script type="text/javascript" src="less-1.3.0.min.js"></script>
  -->

  <script type="text/javascript" src="spin.min.js"></script>
  <script type="text/javascript" src="jquery-1.7.js"></script>
  <script type="text/javascript" src="jquery.console.js"></script>
  <script type="text/javascript" src="jquery.socket-1.0b3.js"></script>
  <script type="text/javascript" src="codemirror.js"></script>
  <script type="text/javascript" src="groovy.js"></script>
  <script type="text/javascript">
  
    $(document).ready(function() {

      // Ajax spinner
      var opts = {
        lines: 13, // The number of lines to draw
        length: 7, // The length of each line
        width: 4, // The line thickness
        radius: 10, // The radius of the inner circle
        rotate: 0, // The rotation offset
        color: '#33B5E5', // #rgb or #rrggbb
        speed: 1, // Rounds per second
        trail: 60, // Afterglow percentage
        shadow: false, // Whether to render a shadow
        hwaccel: false, // Whether to use hardware acceleration
        className: 'spinner', // The CSS class to assign to the spinner
        zIndex: 2e9, // The z-index (defaults to 2000000000)
        top: 'auto', // Top position relative to parent in px
        left: 'auto' // Left position relative to parent in px
      };
      var target = document.getElementById('console');
      var spinner = new Spinner(opts).spin(target);

      // Spinner control
      // spinner start with ajax request
      // spinner stop with ajax request OR at the first message pushed by the server
      var spinnerStart = function() {
        t = setTimeout("showSpinner()", 100)
      };
      var spinnerStop = function() {
        var tmp = t;
        if (tmp) {
          clearTimeout(tmp);
        }
        spinner.stop();
      };

      // Integrate spinner
      var cancel;
      window.showSpinner = function() {
        spinner.spin(target)
      };
      $(document).ajaxStart(spinnerStart);
      $(document).ajaxStop(spinnerStop);

      // Utility function
      var replLinks = function(text) {
        var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return text.replace(exp,"<a href='$1' target='_blank'>$1</a>");
      };

      // Override console filledText to handle our own stuff
      $.fn.filledText = function(txt) {
        var buffer = [];
        for (var i = 0;i < txt.length;i++) {
          var c = txt.charAt(i);
          if (c == '\r') {
            // Ignore
          } else if (c == '\n') {
            buffer.push("<br/>");
          } else if (c == ' ') {
            buffer.push('&nbsp;')
          } else if (c == '<') {
            buffer.push("&lg;")
          } else if (c == '>') {
            buffer.push("&gt;")
          } else {
            buffer.push(c);
          }
        }
        var html = buffer.join("");
        html = html.replace(/ /g,'&nbsp;');
        // html = replLinks(html);
        $(this).html(html);
        return this;
      };

      //
      var demo =
              "\n" +
              "\n" +
              "This CRaSH demo provides a few CRaSH features:\n" +

//              "\n" +
//              "Database:\n" +
//              "% jdbc open java:comp/env/jdbc/crash                       open a connection to the database\n" +
//              "% jdbc info                                                display connection info\n" +
//              "% jdbc execute select count(*) from dual where 1=1         execute some SQL\n" +
//              "% jdbc close                                               close the current jdbc connection\n" +

              "\n" +
              "Cool stuff using server push:\n" +
              "% dashboard                                                show a JVM dashboard\n" +

              "\n" +
              "Threads:\n" +
              "% thread top                                               show all threads\n" +
              "% thread ls                                                list all threads\n" +
              "% thread dump X                                            dump thread X\n" +

              "\n" +
              "System:\n" +
              "% system propget java.version                              display a sytem property\n" +
              "% system freemem                                           display amount of free memory\n" +

              "\n" +
              "Type 'help' to show the available commands\n";

      //
      var ID; // The current connection id
      var reportRef; // The report function provided by the console
      var controller; // The controller jQuery object
      var alternate = false; // The alternate buffer

      //
      var takeAlternate = function() {
        if (!alternate) {
          controller.inner.children(":not(textarea)").hide();
          alternate = true;
        }
      };

      //
      var releaseAlternate = function() {
        if (alternate) {
          controller.inner.find(":visible:not(textarea)").remove();
          controller.inner.children(":hidden:not(textarea)").show();
          alternate = false;
        }
      };

      // The function that handle messages from server
      var message = function(data) {

        // Stop spinner (if it wasn't already stopped)
        spinnerStop();

        // Find the visible jquery-console-message that is also the last child (it may be null)
        var last = controller.inner.find(".jquery-console-message:visible:last-child");

        // Use the jquery-console-message element if that's the last one
        // otherwise create a new one
        var container;
        if(last.length == 0) {
          container = $("<div class='jquery-console-message' style='display: inline'></div>");
        } else {
          container = last[0];
        }

        // Append
        $(data.elements).each(function(index, value) {
          if (value.type == 'text') {
            var chunk = $("<span></span>").filledText(value.text);
            if (value.fg) {
              chunk.css('color', value.fg);
            }
            if (value.bg) {
              chunk.css('background-color', value.bg);
            }
            $(container).append(chunk);
          } else if (value.type == 'cls') {
            // I don't get "find" needs to be used and "children" cannot make it work
            controller.inner.find(":visible:not(textarea)").remove();
          } else if (value.type == 'takeAlternate') {
            takeAlternate();
          } else if (value.type == 'releaseAlternate') {
            releaseAlternate();
          } else {
            // ?
          }
        });

        // Poke directly the result
        controller.inner.append(container);
      };

      // jQuery socket
      $.socket.defaults.transports = ["sse", "stream"];
      $.socket.defaults.timeout = 5000;
      // $.socket.defaults.heartbeat = 20000;
      $.socket("execute")
      .message(message)
    	.connecting(function() {
    		console.log("connecting ...");
    	})
    	.open(function() {
        ID = this.option("id");
    		console.log("connected " + ID);
    	})
    	.close(function(reason) {
    		console.log("closed " + ID + ": " + reason);
        ID = null;
        releaseAlternate();
        if (reportRef != null) {
          reportRef();
        }
      });

      // Get welcome message
      $.ajax({
        url: "welcome",
        async: false,
        dataType: "json",
        success : function(data) {
          controller = $("#console").console({
            promptLabel: data.prompt,
            autofocus: true,
            welcomeMessage : data.welcome + demo,
            cols: 110,
            commandHandle: function(line, report) {

              // Save report for later use (in closed event)
              reportRef = report;

              // Compute width
              var metric = $("#metric").get(0);
              var fontWidth = metric.clientWidth;
              var fontHeight = metric.clientHeight;
              var consoleWidth = $("#console").innerWidth();
              var consoleHeight = $("#console").innerHeight();
              var width = consoleWidth / fontWidth;
              var height = consoleHeight / fontHeight;

              // For now we hardcode ... seems there are issues we won't solve for now
              width = 132;

              // Send message
            	$.socket("execute").send("message", {line: line, width: width, height: height});
            },
            cancelHandle: function() {
              if (ID != null) {
                console.log("cancelling " + ID);
                $.ajax({
                  url: "cancel",
                  data: {id: ID}
                });
              }
            },
            completeHandle: function(prefix) {
              var ret = {};	
              $.ajax({
                url: "complete",
                dataType: "json",
                async: false,
                data: $.param({prefix: prefix}),
                success: function(data) {
                  ret = data;
                }
              });
              return ret;
            }
          });
        }
      });

      // Code mirror
      var textarea = $("#def").each(function() {
        var editor = CodeMirror.fromTextArea(this, {
          mode: "groovy",
          lineNumbers: true,
          textWrapping: false,
          tabindex: 2
//        height: "300px",
//        parserfile: ["tokenizejavascript.js", "parsejavascript.js"],
//        stylesheet: "/css/jscolors.css",
//        path: "/js/",
//        continuousScanning: 500,
//        lineNumbers: true,
//        tabMode: "spaces",
//        submitFunction: function() {
//          jQuery("#executeButton").click();
//        }
        });
      });
    });
  </script>

  <!-- Google Analytics -->
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-18968252-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>

</head>
<body>

<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <ul id="tabs" class="nav">
        <li><a href="http://www.crashub.org/#home">Home</a></li>
        <li><a href="http://www.crashub.org/#doc">Documentation</a></li>
        <li><a href="http://www.crashub.org/javadoc/index.html" target="_blank">Javadoc</a></li>
        <li><a href="http://crash.vietj.cloudbees.net/">Demo</a></li>
      </ul>
    </div>
  </div>
</div>

<div class="container">

  <div class="center">
    <div id="console" class="console">
    </div>
  </div>

  <hr>
  <footer>
    <p>Sponsored by <a href="http://www.exoplatform.com">eXo Platform</a></p>
  </footer>

</div>

<input id="ghi" type="text" value="hello"/>
<textarea id="def" rows="16" cols="80">
class foo {
  @Command
  public void main() {
    out << "hello world";
  }
}
</textarea>
<input id="abc" type="submit" name="save"/>

<!-- Used to determine font metric -->
<div id="metric" class="console" style="position: absolute;visibility: hidden;height: auto; width: auto">
  <div class="jquery-console-message">A</div>
</div>

<script type="text/javascript">
$(function() {
    $("#abc").on("click", function() {
        var name = $("input#ghi").val();
        var script = $("textarea#def").val();
        $.ajax({
            type: "POST",
            url: "script",
            data: { "name": name, "script": script },
            statusCode: {
                400: function(xhr, status, response) {
                    // We should ensure that the response content type is json
                    var json = $.parseJSON(xhr.responseText);
                    alert(json.message);
                }
            }
        });
    });

})
</script>


</body>
</html>